# OS2025 代码导览（lab4/kern/mm）

本节简要说明 `lab4/kern/mm` 目录下各源文件/头文件的职责及它们之间的关系，便于快速上手与定位问题。

## 目录与职责

- `pmm.h` / `pmm.c`（Physical Memory Manager 抽象层）
	- 定义物理内存管理的统一接口：初始化、分配/释放页框、统计/检查等。
	- 持有并调度具体策略实现（例如 `default_pmm`）以完成页级分配。
	- 负责在内核启动早期建立“可用物理内存区间”的视图，并将页框组织成空闲链表等结构。

- `default_pmm.h` / `default_pmm.c`（PMM 默认实现）
	- 物理页分配算法的一个具体实现（如基于空闲链表的首次适配/最佳适配等变体，具体以代码为准）。
	- 提供 `init` / `alloc_pages` / `free_pages` / `nr_free_pages` 等方法，供 `pmm` 抽象层调用。

- `vmm.h` / `vmm.c`（Virtual Memory Manager）
	- 虚拟内存管理：页表的创建与销毁、页表项的查询与分配、映射与解除映射、权限设置等。
	- 常见入口函数包括：
		- 建立或获取二级/三级页表项（RISC‑V 的 `get_pte` 等）。
		- `map/unmap` 或 `page_insert/page_remove`：把物理页映射到指定虚拟地址并设置权限位，或解除映射。
		- 可能包含 `boot_map_segment`/`switch_pgdir`/`sfence.vma` 等与启动映射和 TLB 刷新相关的逻辑。

- `kmalloc.h` / `kmalloc.c`（内核小块内存分配器）
	- 基于页级分配器（PMM）之上的“小对象”动态分配接口，提供 `kmalloc/kfree` 等。
	- 典型实现会以页为基本补给单位，把大页拆分成小块以降低内存碎片与分配开销（具体策略视实现而定）。

- `memlayout.h`（内存布局说明）
	- 定义内核的地址空间布局常量：如内核基址、物理内存上限、各段的基地址/大小、内核栈/空洞区域等。
	- 为 PMM/VMM 的边界检查和映射范围提供统一依据。

- `mmu.h`（体系结构相关 MMU 常量/宏）
	- RISC‑V 页表格式与标志位定义：PTE 权限位（R/W/X/U/G/A/D）、页号位宽、页大小/对齐、SATP 操作等。
	- 常用辅助宏与内联函数：如 PTE 读写、地址与页号转换、`sfence.vma` 刷新等（以实现为准）。

## 关系与调用顺序（典型）

1. 启动阶段初始化 PMM（`pmm_init`）
	 - 解析可用物理内存范围，建立空闲页框结构；设置默认 PMM 策略实现。
2. 初始化 VMM（`vmm` 相关）
	 - 创建/切换内核页表，建立内核的基础映射（内核代码/数据、设备寄存器等）。
3. 初始化内核堆分配器（`kmalloc_init` 如有）
	 - 以 PMM 提供的页为补给，实现面向小对象的 `kmalloc/kfree`。
4. 运行期
	 - 业务侧调用 `kmalloc` 获取小块内存；需要页级映射时通过 `vmm` 完成，底层页源自 `pmm`。

## 快速定位指引

- “页框从哪里来？”看 `pmm.c`/`default_pmm.c`。
- “虚拟地址如何映射成物理地址？”看 `vmm.c`（页表建立/查询/权限）。
- “内核里动态申请一小块内存走哪条路？”看 `kmalloc.c`（以及它如何向 PMM 要页）。
- “权限位/页大小/对齐怎么算？”看 `mmu.h` 与 `memlayout.h`。

如果需要，我可以继续为这些文件补充关键函数列表与调用示意图，或按你的课程要求补充实验步骤与常见调试方法。

